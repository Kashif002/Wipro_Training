<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <div th:replace="fragments/header :: head"></div>
    <title>My Dashboard</title>
    <style>
        .task-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            transition: box-shadow 0.2s;
        }
        .task-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .task-title {
            font-size: 1.5rem;
            margin: 0;
        }
        .task-title a {
            text-decoration: none;
            color: var(--dark-text);
        }
        .task-title a:hover {
            color: var(--primary-color);
        }
        .task-status {
            display: flex;
            align-items: center;
        }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
        .status-PENDING { background-color: #ffc107; color: #333; }
        .status-IN_PROGRESS { background-color: #17a2b8; color: #fff; }
        .status-COMPLETED { background-color: #28a745; color: #fff; }
        .status-DELAYED { background-color: #dc3545; color: #fff; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card h3 { margin: 0 0 0.5rem 0; font-size: 1rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .count { font-size: 2.5rem; font-weight: bold; margin: 0; color: var(--primary-color); }
        .stat-card.pending { border-left-color: #ffc107; }
        .stat-card.pending .count { color: #ffc107; }
        .stat-card.in-progress { border-left-color: #17a2b8; }
        .stat-card.in-progress .count { color: #17a2b8; }
        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.completed .count { color: #28a745; }
        .stat-card.delayed { border-left-color: #dc3545; }
        .stat-card.delayed .count { color: #dc3545; }
        .team-section {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        .team-member {
            display: inline-block;
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .btn { padding: 0.5rem 1rem; border-radius: 5px; border: none; cursor: pointer; font-weight: 500; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .completed-by-admin-badge { background-color: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; }
        .completed-by-admin { border-left: 4px solid #28a745; background-color: #f8f9fa; }
        .welcome-section {
            background: linear-gradient(135deg, var(--primary-color), #667eea);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .welcome-section h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        .welcome-section p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <script>
        // Check authentication on page load
        function checkAuth() {
            const token = sessionStorage.getItem('jwtToken');
            const userRole = sessionStorage.getItem('userRole');
            
            if (!token || (userRole !== 'USER' && userRole !== 'ADMIN')) {
                window.location.href = '/login';
                return;
            }
            
            // If admin tries to access user dashboard, redirect to admin dashboard
            if (userRole === 'ADMIN') {
                window.location.href = '/admin/dashboard';
                return;
            }
            
            // Check if token is expired
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expirationTime = payload.exp * 1000;
                const currentTime = Date.now();
                
                if (currentTime >= expirationTime) {
                    sessionStorage.clear();
                    document.cookie = 'jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                    window.location.href = '/login';
                }
            } catch (error) {
                sessionStorage.clear();
                window.location.href = '/login';
            }
        }
        
        // Check authentication when page loads
        checkAuth();
        
        // Load team members when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTeamMembers();
        });
        
        function loadTeamMembers() {
            const token = sessionStorage.getItem('jwtToken');
            
            fetch('/api/user/team-members', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(teamMembers => {
                const teamContainer = document.getElementById('teamMembers');
                
                if (teamMembers.length === 0) {
                    teamContainer.innerHTML = '<p>No team members found.</p>';
                } else {
                    teamContainer.innerHTML = teamMembers.map(member => 
                        `<span class="team-member">${member.name} (${member.email})</span>`
                    ).join('');
                }
            })
            .catch(error => {
                console.error('Error loading team members:', error);
                document.getElementById('teamMembers').innerHTML = '<p>Failed to load team members.</p>';
            });
        }
    </script>

    <main class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1 th:text="'Welcome, ' + ${user.name} + '!'">Welcome!</h1>
            <p>Ready to tackle your tasks today? Let's make progress together.</p>
        </div>
        
        <!-- Task Statistics -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Tasks</h3>
                <p class="count" th:text="${#lists.size(tasks)}">0</p>
            </div>
            <div class="stat-card pending">
                <h3>Pending</h3>
                <p class="count" th:text="${#lists.size(tasks.?[status == 'PENDING'])}">0</p>
            </div>
            <div class="stat-card in-progress">
                <h3>In Progress</h3>
                <p class="count" th:text="${#lists.size(tasks.?[status == 'IN_PROGRESS'])}">0</p>
            </div>
            <div class="stat-card completed">
                <h3>Completed</h3>
                <p class="count" th:text="${#lists.size(tasks.?[status == 'COMPLETED'])}">0</p>
            </div>
            <div class="stat-card delayed">
                <h3>Delayed</h3>
                <p class="count" th:text="${#lists.size(tasks.?[status == 'DELAYED'])}">0</p>
            </div>
        </div>
        
        <!-- Team Members Section -->
        <div class="team-section" id="teamSection">
            <h3>My Team Members</h3>
            <div id="teamMembers">
                <!-- Team members will be loaded via JavaScript -->
                <p>Loading team members...</p>
            </div>
        </div>
        
        <h2>Your Assigned Tasks</h2>

        <div th:if="${#lists.isEmpty(tasks)}">
            <p>You have no tasks assigned to you. Great job!</p>
        </div>

        <div class="tasks-list">
            <div th:each="task : ${tasks}" class="task-card" th:classappend="${task.completedByAdmin != null and task.completedByAdmin} ? 'completed-by-admin' : ''">
                <div class="task-header">
                    <div>
                        <h3 class="task-title">
                            <a th:href="@{/user/tasks/{id}(id=${task.id})}" th:text="${task.title}">Task Title</a>
                            <span th:if="${task.completedByAdmin != null and task.completedByAdmin}" class="completed-by-admin-badge">Admin Completed</span>
                        </h3>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <small th:if="${task.startDate != null}" th:text="'Start: ' + ${#dates.format(task.startDate, 'dd MMM yyyy')}"></small>
                            <small th:if="${task.dueDate != null}" th:text="'Due: ' + ${#dates.format(task.dueDate, 'dd MMM yyyy')}"></small>
                        </div>
                    </div>
                    <div class="task-status">
                       <span class="status-badge" th:classappend="'status-' + ${task.status}" th:text="${task.status}">STATUS</span>
                    </div>
                </div>
                <p th:text="${task.description}">Task description goes here.</p>
                
                <!-- Additional task info -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.9rem; color: #666;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Assigned by: <strong th:text="${task.assignedBy != null ? task.assignedBy.name : 'System'}">Admin</strong></span>
                        <span>Collaborators: 
                            <span th:each="user, iterStat : ${task.assignedUsers}">
                                <span th:text="${user.name}" th:style="${user.isActive != null and user.isActive} ? '' : 'color: #dc3545;'"></span>
                                <span th:if="${user.isActive != null and !user.isActive}" style="color: #dc3545;"> (On Leave)</span>
                                <span th:if="${!iterStat.last}">, </span>
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="fragments/footer :: footer"></div>
</body>
</html>
